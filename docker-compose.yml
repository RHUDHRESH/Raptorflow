version: '3.8'

services:
  # Redis for task queue and caching
  redis:
    image: redis:7-alpine
    container_name: raptorflow-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - raptorflow-network

  # FastAPI Backend
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: raptorflow-backend
    ports:
      - "8000:8000"
    environment:
      - ENVIRONMENT=development
      - DEBUG=True
      - LOG_LEVEL=DEBUG
      
      # Vertex AI
      - GOOGLE_CLOUD_PROJECT=${GOOGLE_CLOUD_PROJECT}
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS}
      - VERTEX_AI_LOCATION=${VERTEX_AI_LOCATION:-us-central1}
      
      # Supabase
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - SUPABASE_JWT_SECRET=${SUPABASE_JWT_SECRET}
      
      # Redis
      - REDIS_URL=redis://redis:6379/0
      
      # Integrations (optional)
      - CANVA_API_KEY=${CANVA_API_KEY:-}
      - LINKEDIN_CLIENT_ID=${LINKEDIN_CLIENT_ID:-}
      - LINKEDIN_CLIENT_SECRET=${LINKEDIN_CLIENT_SECRET:-}
      - TWITTER_API_KEY=${TWITTER_API_KEY:-}
      - TWITTER_API_SECRET=${TWITTER_API_SECRET:-}
      - INSTAGRAM_APP_ID=${INSTAGRAM_APP_ID:-}
      - INSTAGRAM_APP_SECRET=${INSTAGRAM_APP_SECRET:-}
      
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./backend:/app/backend
      - ${GOOGLE_APPLICATION_CREDENTIALS:-/dev/null}:${GOOGLE_APPLICATION_CREDENTIALS:-/dev/null}:ro
    networks:
      - raptorflow-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # React Frontend (optional - can run separately with npm run dev)
  frontend:
    image: node:20-alpine
    container_name: raptorflow-frontend
    working_dir: /app
    ports:
      - "3000:3000"
    environment:
      - VITE_BACKEND_API_URL=http://localhost:8000/api/v1
      - VITE_SUPABASE_URL=${SUPABASE_URL}
      - VITE_SUPABASE_ANON_KEY=${VITE_SUPABASE_ANON_KEY}
    volumes:
      - ./:/app
      - /app/node_modules
    command: sh -c "npm install && npm run dev -- --host"
    networks:
      - raptorflow-network
    depends_on:
      - backend

volumes:
  redis_data:
    driver: local

networks:
  raptorflow-network:
    driver: bridge
