# Specification: End-to-End Muse with Agent Skills

## 1. Overview
The "Muse" module in RaptorFlow will be transformed into a fully AI-powered "Asset Factory." It will utilize **LangGraph** to orchestrate agents that employ a "Skills" architecture. This system allows for **System Skills** (pre-defined, file-based) and **Custom Skills** (user-defined, database-stored). The backend will use **Vertex AI** (Gemini models) for inference and **Supabase** (PostgreSQL + pgvector) for long-term memory, state checkpointing, and RAG.

## 2. Core Components

### 2.1 The "Skills" Architecture
Inspired by the Agent Skills Open Standard, a "Skill" is a structured package containing:
-   **Manifest/Metadata:** Name, description, inputs, outputs.
-   **Instructions:** System prompt/Markdown defining the behavior.
-   **Tools/Scripts:** Executable logic (Python/JS) or specific tool bindings (e.g., "Search", "Database Query").

#### Storage Strategy (Hybrid)
1.  **System Skills (File-based):** Stored in `raptorflow-app/src/skills/system/`. Hardcoded, version-controlled, highly optimized.
2.  **Custom Skills (DB-based):** Stored in a `skills` table in Supabase. Users can define these via the UI (Markdown instructions).

#### The Comprehensive System Skill Suite
**Core Strategy & Foundation:**
1.  **positioning-refiner:** Extract positioning from raw brain dumps.
2.  **icp-profiler:** Generate detailed Ideal Customer Profile personas.
3.  **brand-voice-guardian:** Compliance check against Brand Kit.
4.  **story-extractor:** Interviews founder to extract `brand-story`.
5.  **landing-page-critic:** Critiques landing page copy.

**Text Asset Skills (1:1 Mapping):**
6.  **cold-outreach-sculptor:** Generates `sales-email`.
7.  **newsletter-architect:** Generates `nurture-email` and general `email`.
8.  **tagline-generator:** Generates `tagline` and `one-liner`.
9.  **video-script-writer:** Generates `video-script`.
10. **social-post-architect:** Generates `social-post` (includes LinkedIn & Twitter logic).
11. **product-storyteller:** Generates `product-description`.
12. **naming-expert:** Generates `product-name` and `domain-name`.
13. **lead-magnet-creator:** Generates `lead-gen-pdf` outlines.
14. **sales-script-writer:** Generates `sales-talking-points`.

**Visual Asset Skills:**
15. **meme-generator:** Generates `meme` concepts (and potentially images via DALL-E/Vertex ImageGen if available).
16. **social-card-designer:** Generates `social-card` layouts/concepts.
17. **wireframe-architect:** Generates `wireframe` descriptions or simple layout JSON.

**Utility:**
18. **content-repurposer:** Splinter one asset into many (Video -> Blog + Tweets).

### 2.2 The Agent Orchestrator (LangGraph)
-   **Framework:** LangGraph.js (Node.js/TS implementation).
-   **Models:**
    -   **Gemini 2.5 Flash (85%):** High-volume tasks (drafting, repurposing) plus deeper reasoning and critique.
    -   **Gemini 2.5 Flash-Lite (15%):** Simple classification, chat routing, and lightweight formatting.
    *(Note: "Gemini 3.5" and "3.0" mentioned in prompt are treated as future/placeholder names; we will use the best available Vertex AI equivalents).*

### 2.3 Memory & RAG (Supabase)
-   **Memory:** LangGraph Checkpointers (`PostgresSaver`) will save agent state to Supabase. This allows a user to "pause" a Muse session and resume it later.
-   **RAG:**
    -   **Ingestion:** "Foundation" docs and "Muse" uploaded assets (PDFs, TXT) are chunked and embedded (Gecko/Vertex Embedding API).
    -   **Storage:** `pgvector` in Supabase.
    -   **Retrieval:** Agents query this store to "know" the user's Brand Voice and past Context.

### 2.4 Tools
-   **RAG Tool:** `retrieve_brand_context(query)`
-   **Search Tool:** `web_search(query)` (using Google Search Grounding in Vertex AI).
-   **Database Tool:** `save_asset(content, type)` (Saves generated output back to Muse Library).

## 3. Functional Requirements

### 3.1 Backend (Next.js API / LangGraph)
-   [ ] **Skill Manager:** Service to load System Skills (files) + Custom Skills (DB) and present them as available Tools to the Agent.
-   [ ] **Agent Graph:** A "Supervisor" or "Routing" graph that:
    1.  Receives user input.
    2.  Decides which "Skill" to activate.
    3.  Executes the Skill (loading its prompt/tools).
    4.  Persists the result.
-   [ ] **Vertex AI Client:** Configured with correct models and safety settings.
-   [ ] **Supabase Client:** Configured for Vector Search and LangGraph Checkpointing.

### 3.2 Frontend (Muse UI)
-   [ ] **Skill Selector:** UI to browse/select active Skills.
-   [ ] **Chat Interface:** Enhanced chat that renders "Thinking..." states and rich artifacts (drafts) generated by the agent.
-   [ ] **Custom Skill Editor:** Simple form to "Create New Skill" (Name, Prompt/Instructions).

## 4. Acceptance Criteria
-   [ ] **10 System Skills Active:** I can run the "Linkedin Writer" skill and get a post formatted correctly.
-   [ ] **Custom Skill Working:** I can create a "Haiku Writer" skill in the UI, and the agent successfully uses it.
-   [ ] **Memory Persistence:** I can refresh the page, and the chat history/context is preserved (LangGraph checkpointing).
-   [ ] **RAG Integration:** The agent can answer "What is my brand voice?" by citing the "Foundation" documents.
-   [ ] **Vertex AI Connected:** Logs show requests going to Gemini 2.5 Flash/Flash-Lite on Vertex AI.

## 5. Technical Constraints
-   **Stack:** Next.js (App Router), LangChain.js / LangGraph.js, Supabase, Vertex AI.
-   **No "Async BS":** Real-time streaming responses where possible, or efficient polling for long-running agent tasks.
