# Specification: Track - Supabase Hardening, AI Onboarding, Multi-Payment (Rupees) & Account Management

## Overview
This track delivers the commercial and multi-tenant backbone of RaptorFlow. It hardens security via the Supabase CLI, enables Gemini-powered onboarding agents, implements a multi-provider payment system (PhonePe +) localized in Rupees, and ensures a seamless account management experience.

## Functional Requirements

### 1. Supabase CLI-Driven Schema & Multi-Tenancy
- **Workspace Management:** `workspaces` table and `members` link to `auth.users`.
- **Global RLS:** Enforce `workspace_id` filtering on all operational tables.
- **Storage Isolation:** Path-isolated Supabase Storage buckets for brand assets.
- **Unified Migration:** Consolidate all schema changes into a master industrial migration via Supabase CLI.

### 2. AI-Enabled End-to-End Onboarding
- **Agent Spine Implementation:**
    - **Architect:** Foundation validation & contradiction detection.
    - **Prophet:** Psychographic ICP generation (2-3 profiles).
    - **Strategist:** 90-day campaign arc & move backlog drafting.
- **Model Routing:** Enforce **Gemini 2.5 Flash (40%)** and **Gemini 2.5 Flash-Lite (60%)** split.
- **Persistence:** AI outputs written to DB before exiting onboarding.

### 3. Multi-Provider Payment Gateway (Rupees)
- **Architecture:** `PaymentProvider` interface for PhonePe + Stripe/Razorpay.
- **Pricing Tiers (Rupees Only):**
    - **Ascent (₹5,000/mo):** 3 Campaigns, 20 Moves, 60 Muse Gens, Metrics.
    - **Glide (₹7,000/mo):** 6 Campaigns, 60 Moves, 200 Muse Gens, Metrics, Black Box, Radar.
    - **Soar (₹10,000/mo):** 9 Campaigns, 150 Moves, 700 Muse Gens, Metrics, Black Box, Radar.

### 4. Account & Settings Management
- **Account View:** Implementation of an "Account" or "Profile" page within Settings.
- **Information Display:** Real-time reflection of the user's Name, Email, Active Plan (Ascent/Glide/Soar), and remaining usage quotas.
- **Invoice List:** View and download historical invoices generated by the system.

### 5. Access Control & Lifecycle
- **Flow:** Sign-up -> AI Onboarding -> Plan Selection -> ₹ Payment -> Workspace Activation -> Dashboard.

## Acceptance Criteria

### 1. Database & Security
- [ ] **CLI Integrity:** `supabase db lint` passes with zero errors.
- [ ] **RLS Enforcement:** Data created by Workspace A is strictly invisible to Workspace B.

### 2. AI Onboarding & Model Fidelity
- [ ] **End-to-End Success:** A new user completes onboarding, and AI-generated ICPs/Arcs are persisted and visible.
- [ ] **Model Split:** Backend telemetry confirms the 40/60 distribution between Gemini 2.5 Flash and 2.5 Flash-Lite.

### 3. Payments, Entitlements & Currency
- [ ] **Currency Consistency:** The currency symbol **₹** and **INR/Rupees** is used in every billing UI, including checkout and invoices.
- [ ] **Tier Gating:** Ascent users are strictly blocked from Glide/Soar features (Black Box, Radar).
- [ ] **Entitlement Reset:** Quotas (Moves/Muse) correctly reset on the next billing date.

### 4. Invoicing & Account UI
- [ ] **Account Transparency:** The "Account" section correctly displays the User's Name, Email, and the name of their current plan (**Ascent, Glide, or Soar**).
- [ ] **Invoice Accuracy:** Invoices reflect the payment amount in ₹ and the specific plan name.

### 5. Lifecycle Verification
- [ ] **End-to-End Flow:** A fresh user can sign up, complete AI onboarding, pay ₹5,000 via PhonePe, and arrive at a dashboard populated with real data.
- [ ] **Paywall Gate:** Unpaid users are automatically redirected to the pricing page if they attempt to access restricted app modules.

## Out of Scope
- Integration with third-party accounting software (e.g., Tally, QuickBooks).
