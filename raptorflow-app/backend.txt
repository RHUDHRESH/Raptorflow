# RaptorFlow Backend Prompt Specification
## Python/FastAPI Backend for Multi-Agent Marketing Intelligence

---

## 1. Project Context

You are building the backend for **RaptorFlow**, a Founder Marketing Operating System. The frontend is a Next.js application that handles:
- **Onboarding**: A multi-step wizard collecting business foundation data.
- **ICPs (Ideal Customer Profiles)**: AI-generated customer personas.
- **Campaigns**: 90-day strategic marketing arcs.
- **Moves**: Tactical execution packets (weekly battle plans).
- **Muse**: An AI content generation studio.

**Your task:** Build a Python/FastAPI backend that:
1. Stores structured data in PostgreSQL (via Supabase).
2. Implements a multi-agent AI system using LangGraph (or LangChain).
3. Exposes REST/WebSocket endpoints for the Next.js frontend.

---

## 2. Tech Stack

- **Language:** Python 3.11+
- **Framework:** FastAPI
- **Database:** PostgreSQL (Supabase)
- **ORM:** SQLAlchemy (or Supabase Python client)
- **AI Framework:** LangGraph, LangChain
- **LLM Provider:** Google Vertex AI (Gemini 1.5 Pro / Gemini 2.0 Flash)
- **Vector Store:** Supabase `pgvector` for RAG
- **Authentication:** Supabase Auth (JWT)

---

## 3. Database Schema (PostgreSQL)

### Table: `tenants`
```sql
CREATE TABLE tenants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    domain VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### Table: `foundations`
```sql
CREATE TABLE foundations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    business_name VARCHAR(255),
    business_type VARCHAR(50), -- 'saas', 'agency', 'd2c', 'local-service', 'creator', 'marketplace', 'other'
    industry VARCHAR(100),
    stage VARCHAR(50), -- 'idea', 'pre-launch', 'beta', 'live', 'scaling', 'early', 'growth'
    offer_statement TEXT,
    price_band VARCHAR(50), -- 'free', 'under-5k', '5k-25k', '25k-1l', '1l-plus'
    sales_motion VARCHAR(50), -- 'self-serve', 'demo-led', 'hybrid'

    -- Confessions (raw user input)
    confession_expensive_problem TEXT,
    confession_embarrassing_truth TEXT,
    confession_stupid_idea TEXT,
    confession_signaling TEXT,
    confession_friction TEXT,

    -- Cohort Data
    customer_type VARCHAR(50)[], -- Array: ['b2b', 'b2c', 'b2g', 'mixed']
    buyer_role_chips VARCHAR(50)[], -- Array: ['founder', 'marketing', 'sales', 'ops', 'finance']
    primary_regions VARCHAR(50)[], -- Array: ['india', 'us', 'eu', 'global']
    scarf_drivers VARCHAR(50)[], -- Array: ['status', 'certainty', 'autonomy', 'relatedness', 'fairness']
    decision_style VARCHAR(50), -- 'satisficer', 'maximizer'
    risk_tolerance VARCHAR(50), -- 'regret-minimizer', 'opportunity-seeker'

    -- Customer Insights
    best_customers TEXT[],
    trigger_events VARCHAR(50)[], -- Array of events like 'funding-round', 'missed-target'
    alternatives VARCHAR(50)[], -- What they used before: 'spreadsheets', 'hubspot', 'agencies'
    pain_ranking TEXT[], -- Ordered list of pains

    -- Messaging
    voice_preference VARCHAR(50), -- 'calm-premium', 'direct-punchy', 'friendly-warm'

    -- Derived Data (populated by AI agents)
    derived_brand_voice TEXT,
    derived_strategic_pivot TEXT,
    clarity_score REAL, -- 0.0 to 1.0

    completed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### Table: `icps` (Ideal Customer Profiles)
```sql
CREATE TABLE icps (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    foundation_id UUID REFERENCES foundations(id) ON DELETE SET NULL,

    name VARCHAR(255) NOT NULL,
    priority VARCHAR(50), -- 'primary', 'secondary'
    status VARCHAR(50) DEFAULT 'active', -- 'draft', 'active', 'deprecated'
    confidence_score REAL, -- 0.0 to 1.0
    reasoning TEXT, -- AI-generated reasoning for this ICP

    -- Firmographics (JSONB)
    firmographics JSONB,
    /* Example:
    {
        "companyType": ["saas", "agency"],
        "geography": ["us", "eu"],
        "salesMotion": ["self-serve", "demo-led"],
        "budgetComfort": ["5k-25k"],
        "decisionMaker": ["founder", "marketing"]
    }
    */

    -- Pain Map (JSONB)
    pain_map JSONB,
    /* Example:
    {
        "primaryPains": ["No consistent content", "Lack of pipeline"],
        "secondaryPains": ["Random marketing efforts"],
        "triggerEvents": ["funding-round", "missed-target"],
        "urgencyLevel": "now"
    }
    */

    -- Psycholinguistics (JSONB)
    psycholinguistics JSONB,
    /* Example:
    {
        "mindsetTraits": ["skeptical", "data-driven"],
        "emotionalTriggers": ["fomo", "control"],
        "tonePreference": ["direct", "no-fluff"],
        "wordsToUse": ["ROI", "system", "proof"],
        "wordsToAvoid": ["synergy", "delighted"],
        "proofPreference": ["case-study", "metrics"],
        "ctaStyle": ["direct"]
    }
    */

    -- Disqualifiers (JSONB)
    disqualifiers JSONB,
    /* Example:
    {
        "excludedCompanyTypes": ["enterprise"],
        "excludedGeographies": ["apac"],
        "excludedBehaviors": ["needs 6+ months to decide"]
    }
    */

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### Table: `campaigns`
```sql
CREATE TABLE campaigns (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    objective VARCHAR(50), -- 'acquire', 'convert', 'launch', 'proof', 'retain', 'reposition'
    status VARCHAR(50) DEFAULT 'planned', -- 'planned', 'active', 'paused', 'wrapup', 'archived'

    cohort_id UUID REFERENCES icps(id) ON DELETE SET NULL,
    offer VARCHAR(50), -- 'book_call', 'start_trial', 'download', 'buy_now'
    channels VARCHAR(50)[], -- Array: ['linkedin', 'email', 'instagram', 'whatsapp']
    duration INT DEFAULT 90, -- days

    arc_data JSONB, -- The 90-day strategy arc generated by AI
    audit_data JSONB, -- Campaign audit results
    quality_score REAL, -- 0.0 to 1.0

    start_date TIMESTAMP,
    end_date TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### Table: `moves`
```sql
CREATE TABLE moves (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    campaign_id UUID REFERENCES campaigns(id) ON DELETE CASCADE,
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,

    title VARCHAR(255) NOT NULL,
    description TEXT,
    goal VARCHAR(50), -- 'leads', 'calls', 'sales', 'proof', 'distribution', 'activation'
    channel VARCHAR(50), -- 'linkedin', 'email', etc.
    duration INT DEFAULT 7, -- days
    daily_effort INT DEFAULT 30, -- minutes

    status VARCHAR(50) DEFAULT 'queued', -- 'draft', 'queued', 'active', 'completed', 'abandoned'
    priority INT DEFAULT 1,

    checklist JSONB, -- Array of checklist items
    /* Example:
    [
        { "id": "uuid", "label": "Write hook", "group": "create", "completed": false },
        { "id": "uuid", "label": "Post to LinkedIn", "group": "publish", "completed": false }
    ]
    */

    refinement_data JSONB, -- AI refinement details
    tool_requirements TEXT[],

    self_report JSONB, -- User's completion report
    /* Example:
    { "didComplete": true, "whatHappened": "Got 5 calls booked", "metrics": { "name": "calls", "value": 5 } }
    */

    started_at TIMESTAMP,
    due_date TIMESTAMP,
    completed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### Table: `muse_assets`
```sql
CREATE TABLE muse_assets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,

    type VARCHAR(50), -- 'post', 'email', 'ad', 'landing-page', 'script'
    title VARCHAR(255),
    content TEXT,
    hook TEXT,

    cohort_id UUID REFERENCES icps(id) ON DELETE SET NULL,
    campaign_id UUID REFERENCES campaigns(id) ON DELETE SET NULL,
    move_id UUID REFERENCES moves(id) ON DELETE SET NULL,

    performance_data JSONB, -- { impressions, clicks, conversions }

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
-- Add vector column for RAG
ALTER TABLE muse_assets ADD COLUMN embedding vector(768);
```

### Table: `blackbox_logs` (Experiment & Learning Storage)
```sql
CREATE TABLE blackbox_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    log_type VARCHAR(50), -- 'experiment', 'override', 'learning', 'pivot'

    context JSONB, -- Full context of what happened
    outcome JSONB, -- What was learned

    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 4. API Endpoints

### Onboarding & Foundation
- `POST /api/v1/onboarding/process` - Triggers the multi-agent synthesis pipeline.
    - **Input:** `FoundationData` (full JSON payload from the wizard)
    - **Output:** `{ icps: [], campaign: {}, moves: [], status: [] }`
    - **Timeout:** 120 seconds (long-running synthesis)

### Campaigns
- `GET /api/v1/campaigns` - List all campaigns for tenant
- `POST /api/v1/campaigns` - Create a new campaign
- `GET /api/v1/campaigns/{id}` - Get single campaign
- `PATCH /api/v1/campaigns/{id}` - Update campaign
- `DELETE /api/v1/campaigns/{id}` - Archive campaign
- `POST /api/v1/campaigns/generate-arc/{id}` - Trigger AI to generate the 90-day arc
- `POST /api/v1/campaigns/{id}/pivot` - Apply a strategic pivot (logs to blackbox)

### Moves
- `GET /api/v1/moves` - List all moves
- `GET /api/v1/moves?campaign_id={id}` - List moves for a campaign
- `POST /api/v1/moves` - Create a move
- `PATCH /api/v1/moves/{id}` - Update move
- `PATCH /api/v1/moves/{id}/status` - Update move status (and trigger agent logic if completed)
- `POST /api/v1/moves/generate-weekly/{campaign_id}` - Generate next week's moves

### ICPs
- `GET /api/v1/icps` - List ICPs
- `POST /api/v1/icps/regenerate` - Trigger AI to regenerate ICPs from foundation

### Muse (Assets)
- `POST /api/v1/muse/generate` - Generate content asset
- `GET /api/v1/muse/assets` - List assets
- `POST /api/v1/muse/search` - RAG search over assets (vector similarity)

---

## 5. AI Agent Architecture (LangGraph)

You will implement a multi-agent graph with three primary nodes:

### Agent 1: The Architect (Foundation Validator)
- **Role:** Analyzes raw foundation data for contradictions.
- **Input:** `FoundationData` object.
- **Tools:**
    - `contradiction_detector`: Flags if business stage mismatches sales motion (e.g., "early stage" + "enterprise sales").
    - `voice_calibrator`: Analyzes user-written text to determine the true `brandVoice`.
- **Output:** `{ valid: bool, contradictions: [], suggestedVoice: str, strategicPivot: str }`

### Agent 2: The Prophet (ICP Generator)
- **Role:** Uses LLM reasoning to generate 3 emergent ICPs from the Foundation.
- **Input:** Validated `FoundationData`.
- **Tools:**
    - `market_sentiment_sim`: Simulates how a specific buyer persona would react to the offer.
    - `trigger_mapper`: Connects trigger events to buyer behaviors.
- **Output:** Array of 3 `ICP` objects with full schema.
- **Prompt Logic:** "Do NOT use generic templates. Deeply analyze the 'Confessions' and 'Pain Rankings'. Use 'SCARF Drivers' to build psychographic depth."

### Agent 3: The Strategist (Campaign & Move Generator)
- **Role:** Generates the initial 90-day campaign and first 3 moves.
- **Input:** Validated Foundation + Primary ICP.
- **Tools:**
    - `backlog_generator`: Creates a prioritized list of moves.
    - `priority_ranker`: Sorts moves by ROI vs. Effort.
- **Output:** `{ campaign: {}, moves: [] }`

### Graph Flow (LangGraph StateGraph)
```
__start__ --> architect --> prophet --> strategist --> __end__
```
Each node receives the cumulative state and adds its output.

---

## 6. Tool Specifications

### `contradiction_detector`
**Description:** Analyzes business stage vs. sales motion and flags mismatches.
**Input Schema:**
```json
{ "stage": "early", "salesMotion": "enterprise-led", "customerType": ["b2b"] }
```
**Output:**
```json
{ "hasContradiction": true, "message": "Early-stage businesses rarely support enterprise sales." }
```

### `market_sentiment_sim`
**Description:** Simulates how a buyer persona would react to an offer statement.
**Input:**
```json
{ "persona": "Tech Founder", "offerStatement": "Weekly marketing moves delivered to your inbox." }
```
**Output:**
```json
{ "reaction": "positive", "objections": ["How much time does this take?"], "hook": "Control over marketing chaos" }
```

### `backlog_generator`
**Description:** Generates a prioritized list of tactical moves for a 90-day campaign.
**Input:** Foundation + ICP + Campaign Objective.
**Output:** Array of Move objects.

---

## 7. RAG System for Muse

Implement a RAG (Retrieval-Augmented Generation) system for the Muse content studio:
1. **Embed all Muse assets** using `text-embedding-004` (Vertex AI).
2. **Store embeddings** in the `muse_assets.embedding` column (pgvector).
3. **On content generation**, retrieve the 5 most similar past assets for context.
4. **Pass context to Gemini** to ensure brand consistency.

---

## 8. Security & Auth

- All endpoints require a valid `Authorization: Bearer <JWT>` header.
- JWTs are issued by Supabase Auth.
- Extract `tenant_id` from the JWT claims to scope all DB queries.

---

## 9. Environment Variables

```env
SUPABASE_URL=<your-supabase-url>
SUPABASE_SERVICE_ROLE_KEY=<your-service-role-key>
GOOGLE_CLOUD_PROJECT=<your-gcp-project>
GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account.json
VERTEX_AI_LOCATION=us-central1
```

---

## 10. Deliverables

1. **`main.py`**: FastAPI application with CORS, routers, and lifespan.
2. **`routers/`**: Separate routers for `onboarding`, `campaigns`, `moves`, `icps`, `muse`.
3. **`agents/spine.py`**: LangGraph workflow with Architect, Prophet, Strategist nodes.
4. **`agents/tools.py`**: Tool implementations (`contradiction_detector`, etc.).
5. **`db/models.py`**: SQLAlchemy models or Pydantic schemas.
6. **`db/supabase.py`**: Supabase client initialization.
7. **`services/rag.py`**: RAG system for Muse.
8. **`alembic/`**: Database migrations (optional, if using SQLAlchemy).

---

**CRITICAL:**
- Every agent response must be JSON-parsable.
- Use Gemini 1.5 Pro for complex reasoning (ICPs, Campaigns).
- Use Gemini 2.0 Flash for quick validation (Architect).
- Handle timeouts gracefully (synthesis can take 60+ seconds).
- Log all agent activity to `blackbox_logs` for learning.

---

Build this backend to be **production-grade**. Assume the frontend is already complete and waiting for these endpoints.
