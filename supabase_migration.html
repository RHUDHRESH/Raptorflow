<!DOCTYPE html>
<html>
<head>
    <title>Supabase Migration Runner</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Supabase Migration Runner</h1>
    <button onclick="runMigration()">Run Migration</button>
    <div id="output"></div>

    <script>
        const { createClient } = supabase;
        
        const supabaseUrl = 'https://vpwwzsanuyhpkvgorcnc.supabase.co';
        const supabaseServiceKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwd3d6c2FudXlocGt2Z29yY25jIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MjM5OTU5MSwiZXhwIjoyMDc3OTc1NTkxfQ.6Q7hAvurQR04cYXg0MZPv7-OMBTMqNKV1N02rC_OOnw';
        
        const supabaseClient = createClient(supabaseUrl, supabaseServiceKey);
        
        const migrationSQL = `-- 20260118_google_auth_profiles.sql
-- COMPREHENSIVE AUTH & PROFILES SETUP
-- Run this in Supabase SQL Editor to fix auth and profile creation

-- 1. Create Profiles Table (Idempotent)
CREATE TABLE IF NOT EXISTS public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT NOT NULL,
  full_name TEXT,
  avatar_url TEXT,
  role TEXT DEFAULT 'user',
  workspace_id UUID,
  plan_tier TEXT DEFAULT 'free',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. Enable RLS
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- 3. Create RLS Policies (Drop existing first to avoid conflicts)
DROP POLICY IF EXISTS "Users can view own profile" ON public.profiles;
DROP POLICY IF EXISTS "Users can update own profile" ON public.profiles;

CREATE POLICY "Users can view own profile" ON public.profiles
  FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update own profile" ON public.profiles
  FOR UPDATE USING (auth.uid() = id);

-- 4. Create Function to Handle New Users (with Avatar & Name capture)
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, email, full_name, avatar_url)
  VALUES (
    NEW.id,
    NEW.email,
    -- Extract metadata from Google OAuth
    COALESCE(NEW.raw_user_meta_data->>'full_name', NEW.raw_user_meta_data->>'name', ''),
    COALESCE(NEW.raw_user_meta_data->>'avatar_url', NEW.raw_user_meta_data->>'picture', '')
  )
  ON CONFLICT (id) DO UPDATE SET
    email = EXCLUDED.email,
    full_name = EXCLUDED.full_name,
    avatar_url = EXCLUDED.avatar_url,
    updated_at = NOW();
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 5. Recreate Trigger
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- 6. Backfill existing users (if any exist without profiles)
INSERT INTO public.profiles (id, email, full_name, avatar_url)
SELECT 
  id, 
  email, 
  COALESCE(raw_user_meta_data->>'full_name', raw_user_meta_data->>'name', ''),
  COALESCE(raw_user_meta_data->>'avatar_url', raw_user_meta_data->>'picture', '')
FROM auth.users
WHERE id NOT IN (SELECT id FROM public.profiles)
ON CONFLICT (id) DO NOTHING;`;

        async function runMigration() {
            const output = document.getElementById('output');
            output.innerHTML = '<p>Starting migration...</p>';
            
            try {
                // This won't work through REST API, but let's try to at least create the table
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .limit(1);
                
                if (error && error.code === 'PGRST116') {
                    // Table doesn't exist, we need to use SQL editor
                    output.innerHTML += '<p>❌ Table does not exist. This migration must be run manually in the Supabase SQL Editor.</p>';
                    output.innerHTML += '<p>Please go to: <a href="https://app.supabase.com/project/vpwwzsanuyhpkvgorcnc/sql" target="_blank">https://app.supabase.com/project/vpwwzsanuyhpkvgorcnc/sql</a></p>';
                    output.innerHTML += '<p>And paste the SQL from the migration file.</p>';
                } else {
                    output.innerHTML += '<p>✅ Profiles table already exists!</p>';
                }
                
                // Display the SQL that needs to be run
                output.innerHTML += '<h3>SQL to run manually:</h3>';
                output.innerHTML += '<textarea style="width: 100%; height: 400px; font-family: monospace;">' + migrationSQL + '</textarea>';
                
            } catch (error) {
                output.innerHTML += '<p>❌ Error: ' + error.message + '</p>';
            }
        }
    </script>
</body>
</html>
